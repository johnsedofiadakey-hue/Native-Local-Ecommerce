// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - Core System States
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MERCHANT
  CUSTOMER
  SUPPORT
}

enum DocumentType {
  GHANA_CARD_FRONT
  GHANA_CARD_BACK
  BUSINESS_CERTIFICATE
  PROFILE_PHOTO
}

enum MerchantStatus {
  PENDING_SETUP
  PENDING_VERIFICATION
  VERIFIED
  SUSPENDED
  BANNED
}

enum VerificationStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
  REQUIRES_RESUBMISSION
}

enum StoreCategory {
  FASHION
  ELECTRONICS
  BEAUTY
  FOOD
  GENERAL_RETAIL
}

enum StoreStatus {
  DRAFT
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum OrderStatus {
  PLACED
  ACCEPTED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  FAILED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  DISPUTED
}

enum PaymentMethod {
  MOBILE_MONEY
  CARD
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum DeliveryOption {
  PICKUP
  MERCHANT_DELIVERY
  CUSTOMER_ARRANGED
}

enum DisputeStatus {
  OPEN
  MERCHANT_RESPONDED
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum DisputeType {
  NOT_DELIVERED
  WRONG_ITEM
  DAMAGED_ITEM
  INCOMPLETE_ORDER
  POOR_QUALITY
  CUSTOMER_REFUSAL
  OTHER
}

enum SubscriptionPlan {
  STARTER
  BUSINESS
  PRO
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  GRACE_PERIOD
  SUSPENDED
  CANCELLED
  EXPIRED
}

enum EnforcementActionType {
  WARNING
  FEATURE_RESTRICTION
  STORE_SUSPENSION
  PERMANENT_BAN
  IDENTITY_BLACKLIST
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYMENT
  VERIFICATION
  DISPUTE
  ENFORCEMENT
  OVERRIDE
  
  // Merchant actions
  MERCHANT_ONBOARDING_STARTED
  MERCHANT_PROFILE_UPDATED
  MERCHANT_DOCUMENT_UPLOADED
  MERCHANT_BANK_DETAILS_UPDATED
  MERCHANT_APPROVED
  MERCHANT_REJECTED
  MERCHANT_SUSPENDED
  MERCHANT_ACTIVATED
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  phone             String   @unique
  phoneVerified     Boolean  @default(false)
  emailVerified     Boolean  @default(false)
  passwordHash      String
  role              UserRole @default(CUSTOMER)
  
  // Security
  isActive          Boolean  @default(true)
  isBanned          Boolean  @default(false)
  banReason         String?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  failedLoginAttempts Int    @default(0)
  lockedUntil       DateTime?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  merchant          Merchant?
  sessions          Session[]
  auditLogs         AuditLog[]
  createdStores     Store[]   @relation("StoreCreator")
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

model Session {
  id              String   @id @default(uuid())
  userId          String
  token           String   @unique
  refreshToken    String?  @unique
  expiresAt       DateTime
  ipAddress       String
  userAgent       String?
  deviceInfo      String?
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model OtpVerification {
  id              String   @id @default(uuid())
  phone           String
  code            String
  purpose         String   // "SIGNUP", "LOGIN", "RESET_PASSWORD"
  expiresAt       DateTime
  verified        Boolean  @default(false)
  attempts        Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([phone, purpose])
  @@map("otp_verifications")
}

// ============================================
// MERCHANTS & VERIFICATION
// ============================================

model Merchant {
  id                    String            @id @default(uuid())
  userId                String            @unique
  status                MerchantStatus    @default(PENDING_SETUP)
  
  // Business Information
  businessName          String?
  businessRegistration  String?           // Ghana business registration number
  taxId                 String?
  
  // Contact
  primaryPhone          String
  alternativePhone      String?
  businessEmail         String?
  
  // Identity Verification
  ghanaCardNumber       String?
  ghanaCardFrontUrl     String?
  ghanaCardBackUrl      String?
  verificationStatus    VerificationStatus @default(NOT_SUBMITTED)
  verificationNotes     String?
  verifiedAt            DateTime?
  verifiedBy            String?           // Admin user ID
  
  // Physical Location
  city                  String?
  area                  String?
  streetAddress         String?
  digitalAddress        String?           // Ghana Post GPS
  landmark              String?
  
  // Trust & Performance
  trustScore            Float             @default(0)
  totalOrders           Int               @default(0)
  completedOrders       Int               @default(0)
  cancelledOrders       Int               @default(0)
  disputedOrders        Int               @default(0)
  averageRating         Float?
  
  // Compliance
  acceptedTermsAt       DateTime?
  lastComplianceCheck   DateTime?
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  stores                Store[]
  paystackAccount       PaystackAccount?
  subscription          Subscription?
  disputes              Dispute[]         @relation("MerchantDisputes")
  enforcementActions    EnforcementAction[]
  
  @@index([status])
  @@index([verificationStatus])
  @@index([city])
  @@map("merchants")
}

// ============================================
// PAYMENT ACCOUNTS
// ============================================

model PaystackAccount {
  id                    String   @id @default(uuid())
  merchantId            String   @unique
  
  // Paystack Integration
  paystackCustomerCode  String?  @unique
  paystackSubaccountCode String? @unique
  businessName          String
  settlementBank        String?
  accountNumber         String?
  
  // Status
  isVerified            Boolean  @default(false)
  isActive              Boolean  @default(false)
  verifiedAt            DateTime?
  
  // Metadata
  metadata              Json?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  merchant              Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  @@index([paystackCustomerCode])
  @@map("paystack_accounts")
}

// ============================================
// STORES & STOREFRONTS
// ============================================

model Store {
  id                String        @id @default(uuid())
  merchantId        String
  createdBy         String
  
  // Store Identity
  name              String
  slug              String        @unique
  category          StoreCategory
  status            StoreStatus   @default(DRAFT)
  
  // Branding
  logo              String?
  bannerImage       String?
  brandColor        String?       @default("#000000")
  description       String?
  
  // SEO & Discovery
  metaTitle         String?
  metaDescription   String?
  keywords          String[]
  
  // Location
  city              String
  area              String
  address           String?
  
  // Settings
  isPublished       Boolean       @default(false)
  minOrderAmount    Decimal?      @db.Decimal(10, 2)
  hasDelivery       Boolean       @default(true)
  hasPickup         Boolean       @default(true)
  
  // Performance
  viewCount         Int           @default(0)
  orderCount        Int           @default(0)
  
  // Timestamps
  publishedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  merchant          Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  creator           User          @relation("StoreCreator", fields: [createdBy], references: [id])
  products          Product[]
  orders            Order[]
  reviews           Review[]
  
  @@index([slug])
  @@index([merchantId])
  @@index([category])
  @@index([status])
  @@map("stores")
}

// ============================================
// PRODUCTS & INVENTORY
// ============================================

model Product {
  id                String    @id @default(uuid())
  storeId           String
  
  // Basic Info
  name              String
  slug              String
  description       String?
  shortDescription  String?
  
  // Pricing
  price             Decimal   @db.Decimal(10, 2)
  compareAtPrice    Decimal?  @db.Decimal(10, 2) // Original price for discounts
  costPrice         Decimal?  @db.Decimal(10, 2) // Internal cost
  
  // Inventory
  sku               String?
  trackInventory    Boolean   @default(false)
  stockQuantity     Int?
  lowStockThreshold Int?
  
  // Availability
  isAvailable       Boolean   @default(true)
  isFeatured        Boolean   @default(false)
  
  // Media
  images            String[]
  thumbnail         String?
  
  // Category-specific
  specs             Json?     // For electronics
  ingredients       Json?     // For food/beauty
  prepTime          Int?      // Minutes for food
  warranty          String?   // For electronics
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  
  // Stats
  viewCount         Int       @default(0)
  orderCount        Int       @default(0)
  averageRating     Float?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  store             Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variants          ProductVariant[]
  orderItems        OrderItem[]
  reviews           Review[]
  
  @@unique([storeId, slug])
  @@index([storeId])
  @@index([isAvailable])
  @@map("products")
}

model ProductVariant {
  id                String    @id @default(uuid())
  productId         String
  
  // Variant Details
  name              String    // e.g., "Large / Red"
  sku               String?
  price             Decimal?  @db.Decimal(10, 2)
  
  // Options
  options           Json      // { "size": "Large", "color": "Red" }
  
  // Inventory
  stockQuantity     Int?
  isAvailable       Boolean   @default(true)
  
  // Media
  image             String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]
  
  @@index([productId])
  @@map("product_variants")
}

// ============================================
// ORDERS & TRACKING (CRITICAL)
// ============================================

model Order {
  id                String          @id @default(uuid())
  orderNumber       String          @unique  // ORD-XXXXX
  storeId           String
  
  // Customer Info (No account required)
  customerName      String
  customerPhone     String
  customerEmail     String?
  
  // Order Details
  status            OrderStatus     @default(PLACED)
  subtotal          Decimal         @db.Decimal(10, 2)
  deliveryFee       Decimal         @default(0) @db.Decimal(10, 2)
  tax               Decimal         @default(0) @db.Decimal(10, 2)
  discount          Decimal         @default(0) @db.Decimal(10, 2)
  total             Decimal         @db.Decimal(10, 2)
  
  // Delivery
  deliveryOption    DeliveryOption
  deliveryAddress   String?
  deliveryCity      String?
  deliveryArea      String?
  deliveryNotes     String?
  
  // Payment
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus   @default(PENDING)
  paymentReference  String?
  paidAt            DateTime?
  
  // Tracking
  trackingUrl       String?
  statusHistory     Json[]          // Array of status updates with timestamps
  
  // Notes
  customerNotes     String?
  merchantNotes     String?
  internalNotes     String?
  
  // Timestamps (Status tracking)
  placedAt          DateTime        @default(now())
  acceptedAt        DateTime?
  preparingAt       DateTime?
  readyAt           DateTime?
  deliveredAt       DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  store             Store           @relation(fields: [storeId], references: [id])
  items             OrderItem[]
  payment           Payment?
  dispute           Dispute?
  reviews           Review[]
  
  @@index([orderNumber])
  @@index([storeId])
  @@index([customerPhone])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id                String          @id @default(uuid())
  orderId           String
  productId         String
  variantId         String?
  
  // Item Details
  productName       String
  variantName       String?
  price             Decimal         @db.Decimal(10, 2)
  quantity          Int
  subtotal          Decimal         @db.Decimal(10, 2)
  
  // Snapshot of product at order time
  productSnapshot   Json
  
  createdAt         DateTime        @default(now())
  
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product           Product         @relation(fields: [productId], references: [id])
  variant           ProductVariant? @relation(fields: [variantId], references: [id])
  
  @@index([orderId])
  @@map("order_items")
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id                String    @id @default(uuid())
  orderId           String
  productId         String
  storeId           String
  customerId        String?   // Optional - for registered users
  
  // Review Content
  rating            Int       // 1-5 stars
  title             String?
  comment           String?
  images            String[]  // Review images
  
  // Reviewer Info (captured from order)
  reviewerName      String
  reviewerPhone     String
  verifiedPurchase  Boolean   @default(true)
  
  // Engagement
  helpfulCount      Int       @default(0)
  reportCount       Int       @default(0)
  
  // Moderation
  isPublished       Boolean   @default(true)
  isEdited          Boolean   @default(false)
  editedAt          DateTime?
  
  // Merchant Response
  merchantResponse  String?
  merchantRespondedAt DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  store             Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([orderId, productId])
  @@index([productId])
  @@index([storeId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}


// ============================================
// PAYMENTS (CRITICAL SECURITY)
// ============================================

model Payment {
  id                    String        @id @default(uuid())
  orderId               String        @unique
  
  // Payment Details
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("GHS")
  method                PaymentMethod
  status                PaymentStatus @default(PENDING)
  
  // Paystack Integration
  paystackReference     String        @unique
  paystackAccessCode    String?
  paystackAuthUrl       String?
  
  // Verification
  verifiedAt            DateTime?
  webhookReceived       Boolean       @default(false)
  webhookVerified       Boolean       @default(false)
  webhookPayload        Json?
  
  // Metadata
  ipAddress             String?
  metadata              Json?
  
  // Timestamps
  initiatedAt           DateTime      @default(now())
  completedAt           DateTime?
  failedAt              DateTime?
  failureReason         String?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  order                 Order         @relation(fields: [orderId], references: [id])
  
  @@index([paystackReference])
  @@index([status])
  @@map("payments")
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

model Subscription {
  id                String              @id @default(uuid())
  merchantId        String              @unique
  
  // Plan Details
  plan              SubscriptionPlan
  status            SubscriptionStatus  @default(ACTIVE)
  
  // Billing
  price             Decimal             @db.Decimal(10, 2)
  currency          String              @default("GHS")
  billingCycle      String              @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  
  // Dates
  startDate         DateTime
  currentPeriodStart DateTime
  currentPeriodEnd  DateTime
  nextBillingDate   DateTime?
  
  // Grace Period
  inGracePeriod     Boolean             @default(false)
  gracePeriodEndsAt DateTime?
  
  // Warnings
  warningsSent      Int                 @default(0)
  lastWarningAt     DateTime?
  
  // History
  suspendedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  merchant          Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  payments          SubscriptionPayment[]
  
  @@index([merchantId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionPayment {
  id                String      @id @default(uuid())
  subscriptionId    String
  
  amount            Decimal     @db.Decimal(10, 2)
  currency          String      @default("GHS")
  status            PaymentStatus @default(PENDING)
  
  // Paystack
  paystackReference String      @unique
  
  // Verification
  verifiedAt        DateTime?
  paidAt            DateTime?
  
  createdAt         DateTime    @default(now())
  
  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
  
  @@index([subscriptionId])
  @@map("subscription_payments")
}

// ============================================
// DISPUTES & ENFORCEMENT
// ============================================

model Dispute {
  id                String        @id @default(uuid())
  orderId           String        @unique
  merchantId        String
  
  // Dispute Details
  type              DisputeType
  status            DisputeStatus @default(OPEN)
  
  // Customer Claim
  customerName      String
  customerPhone     String
  customerEmail     String?
  description       String
  evidenceUrls      String[]
  
  // Merchant Response
  merchantResponse  String?
  merchantEvidenceUrls String[]
  merchantRespondedAt DateTime?
  
  // Platform Review
  reviewedBy        String?       // Admin user ID
  reviewNotes       String?
  resolution        String?
  resolvedAt        DateTime?
  
  // Outcome
  refundIssued      Boolean       @default(false)
  refundAmount      Decimal?      @db.Decimal(10, 2)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  order             Order         @relation(fields: [orderId], references: [id])
  merchant          Merchant      @relation("MerchantDisputes", fields: [merchantId], references: [id])
  
  @@index([merchantId])
  @@index([status])
  @@map("disputes")
}

model EnforcementAction {
  id                String              @id @default(uuid())
  merchantId        String
  
  action            EnforcementActionType
  reason            String
  description       String?
  
  // Action Details
  effectiveFrom     DateTime            @default(now())
  effectiveUntil    DateTime?
  isPermanent       Boolean             @default(false)
  
  // Admin
  issuedBy          String              // Admin user ID
  reviewedBy        String?
  reviewNotes       String?
  
  // Status
  isActive          Boolean             @default(true)
  revokedAt         DateTime?
  revokedBy         String?
  revocationReason  String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  merchant          Merchant            @relation(fields: [merchantId], references: [id])
  
  @@index([merchantId])
  @@index([isActive])
  @@map("enforcement_actions")
}

// ============================================
// AUDIT LOGGING (IMMUTABLE)
// ============================================

model AuditLog {
  id                String      @id @default(uuid())
  userId            String?
  
  // Action Details
  action            AuditAction
  entity            String      // Table name
  entityId          String      // Record ID
  
  // Changes
  oldValues         Json?
  newValues         Json?
  
  // Context
  ipAddress         String?
  userAgent         String?
  metadata          Json?
  
  // Timestamp (immutable)
  createdAt         DateTime    @default(now())
  
  user              User?       @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id                String      @id @default(uuid())
  key               String      @unique
  value             Json
  description       String?
  isPublic          Boolean     @default(false)
  
  updatedBy         String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("system_config")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String    @id @default(uuid())
  channel     String    // SMS, EMAIL, PUSH
  recipient   String    // Phone number or email
  subject     String?
  message     String
  status      String    // SENT, FAILED, PENDING
  metadata    Json?     // Additional data (message ID, error, etc.)
  
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

